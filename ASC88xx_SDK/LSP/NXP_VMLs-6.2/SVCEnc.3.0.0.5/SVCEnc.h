/*
 * $Header: /rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib/SVCEnc.h 22    14/02/26 1:20p Jaja $
 *
 * Copyright 2007-2011 ______ Inc. All rights reserved.
 *
 * Description:
 *
 * $History: SVCEnc.h $
 * 
 * *****************  Version 22  *****************
 * User: Jaja         Date: 14/02/26   Time: 1:20p
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * UPDATE: Update version number from 3.0.0.4 to 3.0.0.5 - DONE.
 * 
 * *****************  Version 21  *****************
 * User: Jaja         Date: 14/02/26   Time: 1:13p
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * UPDATE: Update version number from 3.0.0.3 to 3.0.0.4 - DONE.
 *
 * *****************  Version 20  *****************
 * User: Jaja         Date: 13/12/06   Time: 2:00p
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * UPDATE: Update version number from 3.0.0.2 to 3.0.0.3 - DONE.
 *
 * *****************  Version 19  *****************
 * User: Jaja         Date: 13/09/14   Time: 5:18p
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * UPDATE: Update version number from 3.0.0.1 to 3.0.0.2 - DONE.
 *
 * *****************  Version 18  *****************
 * User: Jaja         Date: 13/08/30   Time: 9:58a
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * UPDATE: Update version number from 3.0.0.0 to 3.0.0.1 - DONE.
 *
 * *****************  Version 17  *****************
 * User: Jaja         Date: 13/08/13   Time: 5:12p
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * UPDATE: Update version number from 2.1.0.3 to 3.0.0.0 - DONE.
 *
 * *****************  Version 16  *****************
 * User: Jaja         Date: 13/01/17   Time: 9:31a
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 *
 * *****************  Version 15  *****************
 * User: Jaja         Date: 13/01/16   Time: 12:06a
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * UPDATE: Update version number from 2.1.0.2 to 2.1.0.3 - DONE.
 *
 * *****************  Version 14  *****************
 * User: Jaja         Date: 12/11/05   Time: 10:57a
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * UPDATE: Update version number from 2.1.0.1 to 2.1.0.2 - DONE.
 *
 * *****************  Version 13  *****************
 * User: Jaja         Date: 12/11/05   Time: 10:54a
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 *
 * *****************  Version 12  *****************
 * User: Jaja         Date: 12/10/12   Time: 11:42a
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * UPDATE: Update version number from 2.1.0.0 to 2.1.0.1 - DONE.
 *
 * *****************  Version 11  *****************
 * User: Jaja         Date: 12/10/01   Time: 10:58a
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * UPDATE: Update version number from 2.0.0.1 to 2.1.0.0 - DONE.
 *
 * *****************  Version 10  *****************
 * User: Jaja         Date: 12/10/01   Time: 10:41a
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 *
 * *****************  Version 9  *****************
 * User: Jaja         Date: 12/01/11   Time: 10:10p
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * UPDATE: Update version number from 2.0.0.0 to 2.0.0.1 - DONE.
 *
 * *****************  Version 8  *****************
 * User: Jaja         Date: 11/11/23   Time: 6:57p
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * UPDATE: Update version number from 1.1.0.1 to 2.0.0.0 - DONE.
 *
 * *****************  Version 7  *****************
 * User: Jaja         Date: 11/08/01   Time: 4:29p
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * UPDATE: Update version number from 1.1.0.0 to 1.1.0.1 - DONE.
 *
 * *****************  Version 6  *****************
 * User: Jaja         Date: 11/07/22   Time: 4:30p
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * UPDATE: Update version number from 1.0.0.3 to 1.1.0.0 - DONE.
 *
 * *****************  Version 5  *****************
 * User: Jaja         Date: 11/07/20   Time: 12:24p
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * UPDATE: Update version number from 1.0.0.2 to 1.0.0.3 - DONE.
 *
 * *****************  Version 4  *****************
 * User: Jaja         Date: 11/07/06   Time: 9:56a
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * UPDATE: Update version number from 1.0.0.1 to 1.0.0.2 - DONE.
 *
 * *****************  Version 3  *****************
 * User: Jaja         Date: 11/06/30   Time: 1:58p
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * UPDATE: Update version number from 1.0.0.0 to 1.0.0.1 - DONE.
 *
 * *****************  Version 2  *****************
 * User: Jaja         Date: 11/06/27   Time: 9:47a
 * Updated in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 *
 * *****************  Version 1  *****************
 * User: Jaja         Date: 11/06/23   Time: 4:31p
 * Created in $/rd_2/project/Mozart/Linux_Libraries/SVCEnc/SVCEnc_Lib
 * First release version 1.0.0.0 - DONE.
 *
 */

/* =========================================================================================== */
#ifndef __SVCENC_H__
#define __SVCENC_H__

/* =========================================================================================== */
#include <stdio.h>
#include <stdlib.h>

#include "typedef.h"
#include "errordef.h"
#include "global_codec.h"

/* =========================================================================================== */
#define SVCENC_VERSION MAKEFOURCC(3, 0, 0, 5)
#define SVCENC_ID_VERSION "3.0.0.5"

/* =========================================================================================== */
typedef struct svc_enc_init_options
{
	DWORD dwVersion;				// encoder version checking
	DWORD dwMaxFrameWidth;			// Maximum process width, it should not exceed input width
	DWORD dwMaxFrameHeight;			// Maximum process height, it should not exceed input height
	DWORD dwEncWidth; 				// The encoding frame width
	DWORD dwEncHeight;				// The encoding frame height
	DWORD dwInWidth;				// The input frame width
	DWORD dwInHeight;				// The input frame height

	DWORD dwInHorzOffset;			// Input frame horizontal offset, 16 alignment is better
	DWORD dwInVertOffset;			// Input frame vertical offset, 16 alignment is better

	DWORD dwRefFrameNum;			// H.264 reference frame number. Configure 1 or, 2. Default is 2.
	DWORD dwSearchRangeX;			// H.264 Search range. Configure 1, 2, or 4(1 => +-16, 2 => +-32, 4 => +-60). Default 4.
	DWORD dwSearchRangeY;			// H.264 Search range. Configure 1, 2, or 4(1 => +-16, 2 => +-32, 4 => +-60). Default 4.

/* Version 2.0.0.0 modification, 2009.11.25 */
	DWORD dwStreamBusNum;
	DWORD dwFrameBusNum;
/* ======================================== */
	/* ===============================================================================
	  dwTicksPerSecond: total ticks in every second.
	  dwTicksPerFrame: ticks between two consequential frame.
	  frame per second = dwTicksPerSecond/(dwTicksPerFrame*2).
	  If 30 frame per second. Set dwTicksPerSecond=>60000 and dwTicksPerFrame=>1001.
	  If 15 frame per second. Set dwTicksPerSecond=>30000 and dwTicksPerFrame=>1001.
	  =============================================================================== */
	DWORD dwTicksPerSecond;
	DWORD dwTicksPerFrame;
	DWORD dwQuant;					// Quantization value (1~51).

	DWORD dwIntraSliceInterval;		// Intra-slice interval. there are interval number inter-slices between two Intra-slice

	DWORD dwProfile;				// H.264 profile. Configure 0, 1, 2 (0: baseline, 1: main profile, 2: high profile). Default is 2

	BOOL bIntraSliceRefreshEn;		// Intra slice insert or not. If not, there is no Intra-slice exception for start frame. If yes, Intra-slice would be inserted according to dwIntraSliceInterval.
	BOOL bConstrainedIntraPredEn;	// Constrained intra prediction. H.264 coding performance issue. Default: FALSE
	BOOL bAdvancedSkipModeEn;		// Motion estimation configuration for skip mode. H.264 coding performance issue. Default: TRUE
	BOOL bIntra16x16PredEn;			// Intra 16x16 prediction. H.264 coding performance issue. Default: TRUE
	BOOL bInterChmaSADEn;			// Use chrominance motion estimation result as a mode decision factor. Default: FALSE

	DWORD dwIntraRefreshMBNum;		// Intra refresh MBs in Inter-slice.
	DWORD dwBitRate;				// Bit rate
	ERateCtrlFlags eRCType;			// Rate control flag. Currently support RATE_CTRL_VQCB and RATE_CTRL_STRICT_VQCB

	BOOL bEncByteStreamHdr;

	BYTE *pbyObjectMask;            // Mozart V2: the pointer to the object mask information buffer
	SDWORD sdwObjectQp;             // Mozart V2: Object mask object delta Qp
    //BOOL bFastModeEnable;         // Mozart V2: Intra Mode enable/disable in P-Slice
    DWORD dwSpeedNum;

	BYTE *pbyMediaBuff;				// Set external allocated buffer start pointer
	DWORD dwMediaBuffSize;			// Set buffer size of external allocated buffer, used to check if external allocated buffer is enough or not.

    DWORD dwLayerNum;
	BOOL bKeyFrameOnlyMode;
	BOOL bSVCSEIEn;

	/* For PB engine initialization */
	DWORD dwBSBufSize;				/* PB engine buffer size */
	DWORD dwTimeOut;				/* loop checking time */
	DWORD dwSemaphore;				/* be used by the pfnEnter and pfnLeave function */
	DWORD dwUserData;				/* be used by the pfnSend function */
	EBufTypeFlags eBufTypeFlags;
	TOnSendData	pfnSend;
	TOnEnterCriticalSec pfnEnter;
	TOnLeaveCriticalSec pfnLeave;

	void *pObjectMem;
	BYTE *pbyYFrame; 				// the pointer to the input Y frame buffer
	BYTE *pbyCbFrame; 				// the pointer to the input U frame buffer
	BYTE *pbyCrFrame; 				// the pointer to the input V frame buffer

	BYTE *pbyEncUserData;			// system must guarantee the size of the decoded user data buffer

} TSVCEncInitOptions;

typedef struct svc_enc_state
{
	DWORD dwSeconds;
	DWORD dwTicks;
	DWORD dwEncBytes;

	DWORD dwEncUserDataLength;

	DWORD dwNALCount;
	DWORD adwNALBytes[16];
	ENALTypeFlags aeNALType[16];
/* Version 3.0.0.0 modification, 2011.06.15 */
	DWORD dwPicTId;
/* ======================================== */

/* Version 2.1.0.0 modification, 2009.12.04 */
	BOOL bIDR;
/* ======================================== */
	BOOL bLast;
} TSVCEncState;


typedef struct svc_roi_windows_infos
{
	BOOL bROIEnable;
	DWORD dwROIWindowNum;	// 0 ~7
	DWORD dwStartMBXNum;
	DWORD dwStartMBYNum;
	DWORD dwEndMBXNum;
	DWORD dwEndMBYNum;
	SDWORD sdwDeltaQp;
	DWORD dwEncodingInterval;
} TSVCEncROIWindowsInfos;

typedef struct svc_enc_options
{
	EVideoOptionFlags eOptionFlags;
	DWORD adwUserData[3];
} TSVCEncOptions;

/* =========================================================================================== */
#ifdef __cplusplus
extern "C" {
#endif

/* Main encoding process functions */
SCODE DLLAPI SVCEnc_Initial(HANDLE *phObject, TSVCEncInitOptions *ptInitOptions);
SCODE DLLAPI SVCEnc_OneFrame(HANDLE hObject, TSVCEncState *ptState);
/* Version 2.2.0.0 modification, 2010.02.01 */
SCODE DLLAPI SVCEnc_StartOneFrame(HANDLE hObject, TSVCEncState *ptState);
SCODE DLLAPI SVCEnc_WaitOneFrame(HANDLE hObject, TSVCEncState *ptState);
/* ======================================== */
SCODE DLLAPI SVCEnc_Release(HANDLE *phObject);

/* This function can't be called simultaneously with the main encoding process functions. */
SCODE DLLAPI SVCEnc_SetOptions(HANDLE hObject, TSVCEncOptions *ptOptions);

SCODE SVCEnc_SpecificConfig_SPS(HANDLE hObject, BYTE *pbySeqBuf, WORD *pwSeqBytes);
SCODE SVCEnc_SpecificConfig_PPS(HANDLE hObject, BYTE *pbyPicBuf, WORD *pwPicBytes);

/* These functions can be called simultaneously with the main encoding process functions. */
SCODE DLLAPI SVCEnc_TakeData(HANDLE hObject, BYTE *pbyBuf, DWORD dwNumBytes);
SCODE DLLAPI SVCEnc_Quit(HANDLE hObject);
DWORD DLLAPI SVCEnc_QueryFilledBufferSpace(HANDLE hObject);
DWORD DLLAPI SVCEnc_QueryMemSize(TSVCEncInitOptions *ptInitOptions);
DWORD DLLAPI SVCEnc_QueryMediaMemSize(TSVCEncInitOptions *ptInitOptions);

SCODE DLLAPI SVCEnc_GetVersionInfo(BYTE *pbyMajor, BYTE *pbyMinor, BYTE *pbyBuild, BYTE *pbyRevision);

extern DWORD dwUsedCount;

//#ifdef __USE_PROFILE__
//float  fBW0, fBW1;
//float  fOp;
//#endif //__USE_PROFILE__

#ifdef __cplusplus
}
#endif

/* =========================================================================================== */
#endif //__SVCENC_H__

/* =========================================================================================== */
